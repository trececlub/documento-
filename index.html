<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Generador de ID Empresarial — Acceso + Generación JPG</title>
  <!-- Librería para leer Excel en el navegador -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --text:#e2e8f0; --muted:#94a3b8; --brand:#6366f1; --accent:#22c55e; --danger:#ef4444; --card:#111827;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--text); font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif}
    .wrap{max-width:1100px; margin:0 auto; padding:24px}
    h1{margin:0 0 12px; font-size:22px}
    h2{margin:18px 0 8px; color:var(--muted); font-size:13px; letter-spacing:.04em; text-transform:uppercase}
    .card{background:var(--panel); border:1px solid #1f2937; border-radius:14px; padding:16px; margin-top:12px}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input, select, button{font:14px/1.2 inherit}
    input[type="text"], input[type="date"], input[type="file"], select{width:100%; padding:10px 12px; border-radius:10px; border:1px solid #1f2937; background:#111827; color:var(--text)}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .row-3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px}
    .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:10px; border:1px solid #1f2937; background:#1f2937; color:#fff; cursor:pointer}
    .btn.primary{background:var(--brand); border-color:transparent}
    .btn.success{background:var(--accent); border-color:transparent}
    .btn.ghost{background:transparent}
    .hint{font-size:12px; color:var(--muted)}
    .grid{display:grid; grid-template-columns:360px 1fr; gap:16px}
    .preview{background:#0d1117; border:1px solid #1f2937; border-radius:14px; padding:12px}
    canvas{max-width:100%; height:auto; border-radius:10px; background:#000}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .ok{color:#22c55e}
    .err{color:#ef4444}
    .sep{height:1px; background:#1f2937; margin:14px 0}
    .pill{display:inline-block; padding:3px 8px; border-radius:999px; background:#111827; color:#94a3b8; font-size:12px}
    details{border:1px dashed #263042; padding:10px 12px; border-radius:10px}
    summary{cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Generador de Carnés / ID Empresarial</h1>
    <p class="hint">App web local (GitHub Pages / offline abriendo este archivo). Plantillas integradas. Exporta <b>JPG</b>.</p>

    <!-- Vista: LOGIN -->
    <section id="view-login" class="card">
      <h2>Acceso por código</h2>
      <p class="hint">Primero carga el Excel con los códigos válidos. Luego escribe tu código para ingresar.</p>
      <div class="row">
        <div>
          <label>Excel de códigos permitidos (.xlsx)</label>
          <input id="xlsx" type="file" accept=".xlsx,.xls" />
          <p id="xlsx-status" class="hint">Aún no cargado.</p>
        </div>
        <div>
          <label>Escribe tu código único</label>
          <input id="access-code" type="text" placeholder="Ej: ABCD-1234" autocomplete="one-time-code" />
          <div class="toolbar">
            <button id="btn-enter" class="btn primary">Ingresar</button>
            <span id="login-msg" class="hint"></span>
          </div>
        </div>
      </div>
      <details style="margin-top:12px">
        <summary>Formato esperado del Excel</summary>
        <p class="hint">Cualquier hoja. Se leerán todos los valores de celdas como posibles códigos. Recomendado: una columna llamada <code>code</code> o la primera columna.</p>
      </details>
    </section>

    <!-- Vista: APP -->
    <section id="view-app" class="card" style="display:none">
      <div class="grid">
        <aside>
          <h2>Datos del documento</h2>
          <label>Surname</label>
          <input id="f-surname" type="text" placeholder="Apellido"/>

          <label>Given name</label>
          <input id="f-given" type="text" placeholder="Nombre"/>

          <label>Code</label>
          <input id="f-code" type="text" placeholder="Código interno"/>

          <label>Category</label>
          <select id="f-category">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select>

          <label>Country of birth</label>
          <select id="f-country"></select>

          <div class="row">
            <div>
              <label>Date of birth</label>
              <input id="f-dob" type="date"/>
            </div>
            <div>
              <label>Sex</label>
              <select id="f-sex">
                <option value="M">M</option>
                <option value="F">F</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Card since</label>
              <input id="f-since" type="date"/>
            </div>
            <div>
              <label>Card expires</label>
              <input id="f-exp" type="date"/>
            </div>
          </div>

          <label>Foto (JPG/PNG)</label>
          <input id="f-photo" type="file" accept="image/*"/>
          <p class="hint">Se ajustará al recuadro de la plantilla (caja morada).</p>

          <div class="sep"></div>
          <div class="toolbar">
            <button id="btn-preview" class="btn">Actualizar vista</button>
            <button id="btn-export" class="btn success">Generar JPG</button>
          </div>

          <h2 style="margin-top:18px">Plantilla</h2>
          <label>Tipo de documento</label>
          <select id="tpl-select"></select>
          <p class="hint">Las plantillas están integradas en la app. Puedes añadir más editando <code>TEMPLATES</code>.</p>

          <details style="margin-top:8px">
            <summary>Opciones avanzadas</summary>
            <label>Nombre de salida</label>
            <input id="out-name" type="text" placeholder="ID_Nombre_Tipo.jpg"/>
            <label>Calidad JPG (0.8–1)</label>
            <input id="jpg-quality" type="text" value="0.92"/>
          </details>
        </aside>

        <div class="preview">
          <h2>Vista previa</h2>
          <canvas id="canvas" width="1011" height="638"></canvas>
          <p class="hint">Tamaño por defecto: CR80 a ~300dpi (1011×638px). Si tu plantilla tiene otro tamaño, cámbialo en la definición.</p>
          <p id="app-msg" class="hint"></p>
        </div>
      </div>
    </section>
  </div>

<script>
/*************************
 * CONFIGURACIÓN
 *************************/
// Lista de países (ISO-3166) en español (extracto representativo; puedes ampliar)
const PAISES = [
  "Afganistán","Albania","Alemania","Andorra","Angola","Antigua y Barbuda","Arabia Saudita","Argelia","Argentina","Armenia","Australia","Austria","Azerbaiyán","Bahamas","Bangladés","Barbados","Baréin","Bélgica","Belice","Benín","Bielorrusia","Bolivia","Bosnia y Herzegovina","Botsuana","Brasil","Brunéi","Bulgaria","Burkina Faso","Burundi","Bután","Cabo Verde","Camboya","Camerún","Canadá","Catar","Chad","Chile","China","Chipre","Colombia","Comoras","Corea del Norte","Corea del Sur","Costa de Marfil","Costa Rica","Croacia","Cuba","Dinamarca","Dominica","Ecuador","Egipto","El Salvador","Emiratos Árabes Unidos","Eritrea","Eslovaquia","Eslovenia","España","Estados Unidos","Estonia","Esuatini","Etiopía","Filipinas","Finlandia","Fiyi","Francia","Gabón","Gambia","Georgia","Ghana","Granada","Grecia","Guatemala","Guinea","Guinea-Bisáu","Guinea Ecuatorial","Guyana","Haití","Honduras","Hungría","India","Indonesia","Irak","Irán","Irlanda","Islandia","Islas Marshall","Islas Salomón","Israel","Italia","Jamaica","Japón","Jordania","Kazajistán","Kenia","Kirguistán","Kiribati","Kuwait","Laos","Lesoto","Letonia","Líbano","Liberia","Libia","Liechtenstein","Lituania","Luxemburgo","Madagascar","Malasia","Malaui","Maldivas","Malí","Malta","Marruecos","Mauricio","Mauritania","México","Micronesia","Moldavia","Mónaco","Mongolia","Montenegro","Mozambique","Namibia","Nauru","Nepal","Nicaragua","Níger","Nigeria","Noruega","Nueva Zelanda","Omán","Países Bajos","Pakistán","Palaos","Panamá","Papúa Nueva Guinea","Paraguay","Perú","Polonia","Portugal","Reino Unido","República Centroafricana","República Checa","República del Congo","República Democrática del Congo","República Dominicana","Ruanda","Rumanía","Rusia","Samoa","San Cristóbal y Nieves","San Marino","San Vicente y las Granadinas","Santa Lucía","Santo Tomé y Príncipe","Senegal","Serbia","Seychelles","Sierra Leona","Singapur","Siria","Somalia","Sri Lanka","Sudáfrica","Sudán","Sudán del Sur","Suecia","Suiza","Surinam","Tailandia","Tanzania","Tayikistán","Timor Oriental","Togo","Tonga","Trinidad y Tobago","Túnez","Turkmenistán","Turquía","Tuvalu","Ucrania","Uganda","Uruguay","Uzbekistán","Vanuatu","Vaticano","Venezuela","Vietnam","Yemen","Yibuti","Zambia","Zimbabue"
];

// Definición de plantillas integradas.
// Reemplaza las rutas src por las imágenes reales en tu repo (por ejemplo, ./templates/empleado_frente.png)
const TEMPLATES = [
  {
    id: "empleado_frente",
    label: "Empleado — Frente",
    width: 1011, height: 638, // CR80 ~300dpi
    src: "https://dummyimage.com/1011x638/ffffff/cccccc.png&text=Plantilla+Empleado+Frente",
    // Mapa de campos (coordenadas en px relativas a este tamaño)
    fields: {
      surname:  { x: 290, y: 190, maxW: 620, font: "bold 36px Inter", color: "#111", align:"left" },
      given:    { x: 290, y: 238, maxW: 620, font: "600 34px Inter", color: "#222", align:"left" },
      code:     { x: 290, y: 286, maxW: 620, font: "500 28px Inter", color: "#333", align:"left" },
      category: { x: 290, y: 334, maxW: 620, font: "500 28px Inter", color: "#333", align:"left" },
      country:  { x: 290, y: 382, maxW: 620, font: "500 26px Inter", color: "#333", align:"left" },
      dob:      { x: 290, y: 430, maxW: 300, font: "500 26px Inter", color: "#333", align:"left" },
      sex:      { x: 620, y: 430, maxW: 120, font: "700 26px Inter", color: "#111", align:"left" },
      since:    { x: 290, y: 478, maxW: 300, font: "500 24px Inter", color: "#333", align:"left" },
      exp:      { x: 620, y: 478, maxW: 300, font: "700 24px Inter", color: "#b91c1c", align:"left" },
    },
    // Área de la foto (rectángulo morado del mapa):
    photo: { x: 64, y: 170, w: 188, h: 248, radius: 12 }
  },
  {
    id: "contratista_frente",
    label: "Contratista — Frente",
    width: 1011, height: 638,
    src: "https://dummyimage.com/1011x638/ffffff/cccccc.png&text=Plantilla+Contratista+Frente",
    fields: {
      surname:  { x: 300, y: 200, maxW: 620, font: "bold 36px Inter", color: "#111", align:"left" },
      given:    { x: 300, y: 248, maxW: 620, font: "600 34px Inter", color: "#222", align:"left" },
      code:     { x: 300, y: 296, maxW: 620, font: "500 28px Inter", color: "#333", align:"left" },
      category: { x: 300, y: 344, maxW: 620, font: "500 28px Inter", color: "#333", align:"left" },
      country:  { x: 300, y: 392, maxW: 620, font: "500 26px Inter", color: "#333", align:"left" },
      dob:      { x: 300, y: 440, maxW: 300, font: "500 26px Inter", color: "#333", align:"left" },
      sex:      { x: 630, y: 440, maxW: 120, font: "700 26px Inter", color: "#111", align:"left" },
      since:    { x: 300, y: 488, maxW: 300, font: "500 24px Inter", color: "#333", align:"left" },
      exp:      { x: 630, y: 488, maxW: 300, font: "700 24px Inter", color: "#b91c1c", align:"left" },
    },
    photo: { x: 70, y: 180, w: 188, h: 248, radius: 12 }
  }
];

/*************************
 * ESTADO
 *************************/
let VALID_CODES = new Set();
let currentTpl = TEMPLATES[0];
let tplImage = new Image();
let photoImage = null; // imagen cargada para la foto

/*************************
 * UTILIDADES
 *************************/
function setText(el, txt){ el.textContent = txt; }
function fmtDate(iso){
  if(!iso) return "";
  const d = new Date(iso);
  if(Number.isNaN(d.getTime())) return iso;
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yy = d.getFullYear();
  return `${dd}/${mm}/${yy}`;
}

function drawRoundedImage(ctx, img, x, y, w, h, r){
  ctx.save();
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.lineTo(x+w-rr, y);
  ctx.quadraticCurveTo(x+w, y, x+w, y+rr);
  ctx.lineTo(x+w, y+h-rr);
  ctx.quadraticCurveTo(x+w, y+h, x+w-rr, y+h);
  ctx.lineTo(x+rr, y+h);
  ctx.quadraticCurveTo(x, y+h, x, y+h-rr);
  ctx.lineTo(x, y+rr);
  ctx.quadraticCurveTo(x, y, x+rr, y);
  ctx.closePath();
  ctx.clip();
  // cubrir el área manteniendo proporción (cover)
  const ar = img.width / img.height;
  const boxAr = w / h;
  let drawW, drawH;
  if(ar > boxAr){ // imagen más ancha
    drawH = h;
    drawW = h * ar;
  } else {
    drawW = w;
    drawH = w / ar;
  }
  const dx = x + (w - drawW)/2;
  const dy = y + (h - drawH)/2;
  ctx.drawImage(img, dx, dy, drawW, drawH);
  ctx.restore();
}

function drawText(ctx, spec, text){
  if(!text) return;
  ctx.font = spec.font;
  ctx.fillStyle = spec.color;
  ctx.textAlign = spec.align || 'left';
  ctx.textBaseline = 'alphabetic';
  // cortar si excede maxW
  let t = text;
  if(spec.maxW){
    while(t.length && ctx.measureText(t).width > spec.maxW){ t = t.slice(0, -1); }
    if(t !== text) t = t.trim() + '…';
  }
  ctx.fillText(t, spec.x, spec.y);
}

function downloadJPG(canvas, filename, quality=0.92){
  const url = canvas.toDataURL('image/jpeg', Math.min(Math.max(quality,0.5),1));
  const a = document.createElement('a');
  a.href = url; a.download = filename || 'documento.jpg';
  document.body.appendChild(a); a.click(); a.remove();
}

/*************************
 * INICIALIZACIÓN UI
 *************************/
const $login = document.getElementById('view-login');
const $app   = document.getElementById('view-app');
const $xlsx  = document.getElementById('xlsx');
const $xlsxStatus = document.getElementById('xlsx-status');
const $access = document.getElementById('access-code');
const $btnEnter = document.getElementById('btn-enter');
const $loginMsg = document.getElementById('login-msg');

const $tplSelect = document.getElementById('tpl-select');
const $canvas = document.getElementById('canvas');
const ctx = $canvas.getContext('2d');

const $surname = document.getElementById('f-surname');
const $given   = document.getElementById('f-given');
const $code    = document.getElementById('f-code');
const $category= document.getElementById('f-category');
const $country = document.getElementById('f-country');
const $dob     = document.getElementById('f-dob');
const $sex     = document.getElementById('f-sex');
const $since   = document.getElementById('f-since');
const $exp     = document.getElementById('f-exp');
const $photo   = document.getElementById('f-photo');
const $btnPrev = document.getElementById('btn-preview');
const $btnExp  = document.getElementById('btn-export');
const $outName = document.getElementById('out-name');
const $jpgQ    = document.getElementById('jpg-quality');
const $appMsg  = document.getElementById('app-msg');

function fillCountries(){
  $country.innerHTML = '';
  for(const p of PAISES){
    const opt = document.createElement('option');
    opt.value = p; opt.textContent = p; $country.appendChild(opt);
  }
}

function fillTemplates(){
  $tplSelect.innerHTML = '';
  TEMPLATES.forEach((t,i)=>{
    const opt = document.createElement('option');
    opt.value = t.id; opt.textContent = t.label; $tplSelect.appendChild(opt);
  });
  $tplSelect.value = TEMPLATES[0].id;
}

function getTemplateById(id){ return TEMPLATES.find(t=>t.id===id) || TEMPLATES[0]; }

function loadTemplateImage(){
  return new Promise(res=>{
    tplImage = new Image();
    tplImage.crossOrigin = 'anonymous';
    tplImage.onload = ()=>res();
    tplImage.src = currentTpl.src;
  });
}

async function renderPreview(){
  // ajustar canvas al tamaño de la plantilla
  if($canvas.width !== currentTpl.width || $canvas.height !== currentTpl.height){
    $canvas.width = currentTpl.width; $canvas.height = currentTpl.height;
  }
  // fondo plantilla
  ctx.clearRect(0,0,$canvas.width,$canvas.height);
  ctx.drawImage(tplImage, 0,0, $canvas.width, $canvas.height);

  // foto
  if(photoImage){
    const p = currentTpl.photo; drawRoundedImage(ctx, photoImage, p.x, p.y, p.w, p.h, p.radius||0);
  }

  // textos
  const f = currentTpl.fields;
  drawText(ctx, f.surname,  ($surname.value||'').toUpperCase());
  drawText(ctx, f.given,    ($given.value||'').toUpperCase());
  drawText(ctx, f.code,     $code.value||'');
  drawText(ctx, f.category, $category.value||'');
  drawText(ctx, f.country,  $country.value||'');
  drawText(ctx, f.dob,      fmtDate($dob.value));
  drawText(ctx, f.sex,      ($sex.value||'').toUpperCase());
  drawText(ctx, f.since,    fmtDate($since.value));
  drawText(ctx, f.exp,      fmtDate($exp.value));

  setText($appMsg, 'Vista previa actualizada');
}

/*************************
 * MANEJADORES
 *************************/
$xlsx.addEventListener('change', async (e)=>{
  const file = e.target.files[0];
  if(!file){ setText($xlsxStatus,'Aún no cargado.'); return; }
  try{
    const data = await file.arrayBuffer();
    const wb = XLSX.read(data, {type:'array'});
    const codes = new Set();
    wb.SheetNames.forEach(name=>{
      const ws = wb.Sheets[name];
      const json = XLSX.utils.sheet_to_json(ws, {header:1, raw:true, defval:''});
      for(const row of json){
        for(const cell of row){
          const val = String(cell).trim();
          if(val) codes.add(val);
        }
      }
    });
    VALID_CODES = codes;
    setText($xlsxStatus, `Excel cargado. ${codes.size} códigos detectados.`);
  }catch(err){
    console.error(err);
    setText($xlsxStatus, 'Error leyendo el Excel');
  }
});

$btnEnter.addEventListener('click', ()=>{
  const code = ($access.value||'').trim();
  if(!VALID_CODES.size){ setText($loginMsg, 'Primero carga el Excel.'); return; }
  if(!code){ setText($loginMsg, 'Escribe tu código.'); return; }
  if(VALID_CODES.has(code)){
    setText($loginMsg, '');
    // Ir a la app
    $login.style.display='none';
    $app.style.display='block';
    // prefijar Code con el mismo valor
    $code.value = code;
    renderPreview();
  } else {
    setText($loginMsg, 'Código inválido.');
  }
});

$tplSelect.addEventListener('change', async ()=>{
  currentTpl = getTemplateById($tplSelect.value);
  await loadTemplateImage();
  renderPreview();
});

$photo.addEventListener('change', async (e)=>{
  const file = e.target.files[0]; if(!file){ photoImage=null; renderPreview(); return; }
  const url = URL.createObjectURL(file);
  const img = new Image();
  img.onload = ()=>{ photoImage = img; URL.revokeObjectURL(url); renderPreview(); };
  img.src = url;
});

$btnPrev.addEventListener('click', ()=>{ renderPreview(); });
$btnExp.addEventListener('click', ()=>{
  const name = ($outName.value||`ID_${($given.value||'')}_${$category.value||''}.jpg`).replace(/\s+/g,'_');
  const q = parseFloat($jpgQ.value||'0.92') || 0.92;
  downloadJPG($canvas, name, q);
});

// re-render al cambiar cualquier campo
[$surname,$given,$code,$category,$country,$dob,$sex,$since,$exp].forEach(el=>{
  el.addEventListener('input', ()=>{ renderPreview(); });
});

/*************************
 * BOOTSTRAP
 *************************/
(function init(){
  fillCountries();
  fillTemplates();
  currentTpl = TEMPLATES[0];
  loadTemplateImage().then(()=> renderPreview());
})();
</script>
</body>
</html>
