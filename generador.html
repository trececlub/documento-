<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Generador de ID â€” JPG</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --text:#e2e8f0; --muted:#94a3b8; --brand:#6366f1; --accent:#22c55e; --danger:#ef4444; --card:#111827;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--text); font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif}
    .wrap{max-width:1100px; margin:0 auto; padding:24px}
    h1{margin:0 0 12px; font-size:22px}
    h2{margin:18px 0 8px; color:var(--muted); font-size:13px; letter-spacing:.04em; text-transform:uppercase}
    .card{background:var(--panel); border:1px solid #1f2937; border-radius:14px; padding:16px; margin-top:12px}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input, select, button{font:14px/1.2 inherit}
    input[type="text"], input[type="date"], input[type="file"], select{width:100%; padding:10px 12px; border-radius:10px; border:1px solid #1f2937; background:#111827; color:#fff}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .grid{display:grid; grid-template-columns:360px 1fr; gap:16px}
    .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:10px; border:1px solid #1f2937; background:#1f2937; color:#fff; cursor:pointer}
    .btn.primary{background:var(--brand); border-color:transparent}
    .btn.success{background:var(--accent); border-color:transparent}
    .hint{font-size:12px; color:var(--muted)}
    .preview{background:#0d1117; border:1px solid #1f2937; border-radius:14px; padding:12px}
    canvas{max-width:100%; height:auto; border-radius:10px; background:#000}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .sep{height:1px; background:#1f2937; margin:14px 0}
    .link{color:#a5b4fc; text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Generador de CarnÃ©s / ID â€” JPG</h1>
    <p class="hint">Rellena el formulario, carga la foto y exporta el documento en JPG. <a class="link" href="./index.html">Volver al inicio</a></p>

    <section class="card">
      <div class="grid">
        <aside>
          <h2>Datos del documento</h2>
          <label>Surname</label>
          <input id="f-surname" type="text" placeholder="Apellido"/>

          <label>Given name</label>
          <input id="f-given" type="text" placeholder="Nombre"/>

          <label>Code</label>
          <input id="f-code" type="text" placeholder="USCIS CODE"/>

          <label>Category</label>
          <select id="f-category">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select>

          <label>Country of birth</label>
          <select id="f-country"></select>

          <div class="row">
            <div>
              <label>Date of birth</label>
              <input id="f-dob" type="date"/>
            </div>
            <div>
              <label>Sex</label>
              <select id="f-sex">
                <option value="M">M</option>
                <option value="F">F</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Card since</label>
              <input id="f-since" type="date"/>
            </div>
            <div>
              <label>Card expires</label>
              <input id="f-exp" type="date"/>
            </div>
          </div>

          <label>Foto (JPG/PNG)</label>
          <input id="f-photo" type="file" accept="image/*"/>
          <p class="hint">Se ajustarÃ¡ al recuadro de la plantilla.</p>

          <div class="sep"></div>
          <div class="toolbar">
            <button id="btn-preview" class="btn">Actualizar vista</button>
            <button id="btn-export" class="btn success">Generar JPG</button>
          </div>

          <h2 style="margin-top:18px">Plantilla</h2>
          <label>Tipo de documento</label>
          <select id="tpl-select"></select>
          <p class="hint">Las plantillas se leen de <code>./templates/</code>. Ajusta coordenadas en <code>TEMPLATES</code>.</p>

          <div class="sep"></div>
          <label>Nombre de salida</label>
          <input id="out-name" type="text" placeholder="ID_Nombre_Tipo.jpg"/>
          <label>Calidad JPG (0.8â€“1)</label>
          <input id="jpg-quality" type="text" value="0.92"/>
        </aside>

        <div class="preview">
          <h2>Vista previa</h2>
          <canvas id="canvas" width="1011" height="638"></canvas>
          <p id="app-msg" class="hint"></p>
        </div>
      </div>
    </section>
  </div>

<script>
/*************************
 * UTIL â€” leer parÃ¡metro code de la URL
 *************************/
function getQueryParam(name){
  return new URLSearchParams(window.location.search).get(name);
}

/*************************
 * CONFIGURACIÃ“N
 *************************/
const PAISES = [
  "AfganistÃ¡n","Albania","Alemania","Andorra","Angola","Antigua y Barbuda","Arabia Saudita","Argelia","Argentina","Armenia","Australia","Austria","AzerbaiyÃ¡n","Bahamas","BangladÃ©s","Barbados","BarÃ©in","BÃ©lgica","Belice","BenÃ­n","Bielorrusia","Bolivia","Bosnia y Herzegovina","Botsuana","Brasil","BrunÃ©i","Bulgaria","Burkina Faso","Burundi","ButÃ¡n","Cabo Verde","Camboya","CamerÃºn","CanadÃ¡","Catar","Chad","Chile","China","Chipre","Colombia","Comoras","Corea del Norte","Corea del Sur","Costa de Marfil","Costa Rica","Croacia","Cuba","Dinamarca","Dominica","Ecuador","Egipto","El Salvador","Emiratos Ãrabes Unidos","Eritrea","Eslovaquia","Eslovenia","EspaÃ±a","Estados Unidos","Estonia","Esuatini","EtiopÃ­a","Filipinas","Finlandia","Fiyi","Francia","GabÃ³n","Gambia","Georgia","Ghana","Granada","Grecia","Guatemala","Guinea","Guinea-BisÃ¡u","Guinea Ecuatorial","Guyana","HaitÃ­","Honduras","HungrÃ­a","India","Indonesia","Irak","IrÃ¡n","Irlanda","Islandia","Islas Marshall","Islas SalomÃ³n","Israel","Italia","Jamaica","JapÃ³n","Jordania","KazajistÃ¡n","Kenia","KirguistÃ¡n","Kiribati","Kuwait","Laos","Lesoto","Letonia","LÃ­bano","Liberia","Libia","Liechtenstein","Lituania","Luxemburgo","Madagascar","Malasia","Malaui","Maldivas","MalÃ­","Malta","Marruecos","Mauricio","Mauritania","MÃ©xico","Micronesia","Moldavia","MÃ³naco","Mongolia","Montenegro","Mozambique","Namibia","Nauru","Nepal","Nicaragua","NÃ­ger","Nigeria","Noruega","Nueva Zelanda","OmÃ¡n","PaÃ­ses Bajos","PakistÃ¡n","Palaos","PanamÃ¡","PapÃºa Nueva Guinea","Paraguay","PerÃº","Polonia","Portugal","Reino Unido","RepÃºblica Centroafricana","RepÃºblica Checa","RepÃºblica del Congo","RepÃºblica DemocrÃ¡tica del Congo","RepÃºblica Dominicana","Ruanda","RumanÃ­a","Rusia","Samoa","San CristÃ³bal y Nieves","San Marino","San Vicente y las Granadinas","Santa LucÃ­a","Santo TomÃ© y PrÃ­ncipe","Senegal","Serbia","Seychelles","Sierra Leona","Singapur","Siria","Somalia","Sri Lanka","SudÃ¡frica","SudÃ¡n","SudÃ¡n del Sur","Suecia","Suiza","Surinam","Tailandia","Tanzania","TayikistÃ¡n","Timor Oriental","Togo","Tonga","Trinidad y Tobago","TÃºnez","TurkmenistÃ¡n","TurquÃ­a","Tuvalu","Ucrania","Uganda","Uruguay","UzbekistÃ¡n","Vanuatu","Vaticano","Venezuela","Vietnam","Yemen","Yibuti","Zambia","Zimbabue"
];

// âš ï¸ Cambia las rutas src por tus imÃ¡genes reales en ./templates/
const TEMPLATES = [
  {
    id:"card", label:"card",
    width:1011, height:638,
    src:"./templates/card.png",
    fields:{
      surname:{x:290,y:190,maxW:620,font:"bold 36px Inter, system-ui",color:"#111",align:"left"},
      given:{x:290,y:238,maxW:620,font:"600 34px Inter, system-ui",color:"#222",align:"left"},
      code:{x:290,y:286,maxW:620,font:"500 28px Inter, system-ui",color:"#333",align:"left"},
      category:{x:290,y:334,maxW:620,font:"500 28px Inter, system-ui",color:"#333",align:"left"},
      country:{x:290,y:382,maxW:620,font:"500 26px Inter, system-ui",color:"#333",align:"left"},
      dob:{x:290,y:430,maxW:300,font:"500 26px Inter, system-ui",color:"#333",align:"left"},
      sex:{x:620,y:430,maxW:120,font:"700 26px Inter, system-ui",color:"#111",align:"left"},
      since:{x:290,y:478,maxW:300,font:"500 24px Inter, system-ui",color:"#333",align:"left"},
      exp:{x:620,y:478,maxW:300,font:"700 24px Inter, system-ui",color:"#b91c1c",align:"left"}
    },
    photo:{x:64,y:170,w:188,h:248,radius:12}
  },
  {
    id:"social", label:"social",
    width:1011, height:638,
    src:"./templates/social.png",
    fields:{
      surname:{x:300,y:200,maxW:620,font:"bold 36px Inter, system-ui",color:"#111",align:"left"},
      given:{x:300,y:248,maxW:620,font:"600 34px Inter, system-ui",color:"#222",align:"left"},
      code:{x:300,y:296,maxW:620,font:"500 28px Inter, system-ui",color:"#333",align:"left"},
      category:{x:300,y:344,maxW:620,font:"500 28px Inter, system-ui",color:"#333",align:"left"},
      country:{x:300,y:392,maxW:620,font:"500 26px Inter, system-ui",color:"#333",align:"left"},
      dob:{x:300,y:440,maxW:300,font:"500 26px Inter, system-ui",color:"#333",align:"left"},
      sex:{x:630,y:440,maxW:120,font:"700 26px Inter, system-ui",color:"#111",align:"left"},
      since:{x:300,y:488,maxW:300,font:"500 24px Inter, system-ui",color:"#333",align:"left"},
      exp:{x:630,y:488,maxW:300,font:"700 24px Inter, system-ui",color:"#b91c1c",align:"left"}
    },
    photo:{x:70,y:180,w:188,h:248,radius:12}
  }
];

/*************************
 * ESTADO
 *************************/
let currentTpl = TEMPLATES[0];
let tplImage = new Image();
let photoImage = null;

/*************************
 * DOM
 *************************/
const $tplSelect = document.getElementById('tpl-select');
const $canvas = document.getElementById('canvas');
const ctx = $canvas.getContext('2d');

const $surname = document.getElementById('f-surname');
const $given   = document.getElementById('f-given');
const $code    = document.getElementById('f-code');
const $category= document.getElementById('f-category');
const $country = document.getElementById('f-country');
const $dob     = document.getElementById('f-dob');
const $sex     = document.getElementById('f-sex');
const $since   = document.getElementById('f-since');
const $exp     = document.getElementById('f-exp');
const $photo   = document.getElementById('f-photo');
const $btnPrev = document.getElementById('btn-preview');
const $btnExp  = document.getElementById('btn-export');
const $outName = document.getElementById('out-name');
const $jpgQ    = document.getElementById('jpg-quality');
const $appMsg  = document.getElementById('app-msg');

/*************************
 * DEBUG (ver cajas para alinear)
 *************************/
const DEBUG = true; // pon en false cuando termines de calibrar

function drawDebugBoxes(){
  if(!DEBUG) return;
  ctx.save();
  // Foto en morado
  if(currentTpl.photo){
    const p = currentTpl.photo;
    ctx.strokeStyle = '#8b5cf6'; ctx.lineWidth = 2;
    ctx.strokeRect(p.x, p.y, p.w, p.h);
  }
  // Cajas de texto en verde
  const f = currentTpl.fields;
  ctx.strokeStyle = '#10b981'; ctx.lineWidth = 2;
  for(const k of Object.keys(f)){
    const s = f[k];
    const fontPx = parseInt((s.font.match(/(\d+)px/)||[])[1]||'24',10);
    const h = fontPx + 6;                 // alto aprox
    const w = s.maxW || Math.max(80, ctx.measureText('MMMMMMMM').width);
    ctx.strokeRect(s.x, s.y, w, h);       // ahora y es borde superior
  }
  ctx.restore();
}

/*************************
 * UTILS
 *************************/
function setText(el, txt){ el.textContent = txt; }
function fmtDate(iso){
  if(!iso) return "";
  const d = new Date(iso);
  if(Number.isNaN(d.getTime())) return iso;
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yy = d.getFullYear();
  return `${dd}/${mm}/${yy}`;
}
function drawRoundedImage(ctx, img, x, y, w, h, r){
  ctx.save();
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.lineTo(x+w-rr, y);
  ctx.quadraticCurveTo(x+w, y, x+w, y+rr);
  ctx.lineTo(x+w, y+h-rr);
  ctx.quadraticCurveTo(x+w, y+h, x+w-rr, y+h);
  ctx.lineTo(x+rr, y+h);
  ctx.quadraticCurveTo(x, y+h, x, y+h-rr);
  ctx.lineTo(x, y+rr);
  ctx.quadraticCurveTo(x, y, x+rr, y);
  ctx.closePath();
  ctx.clip();
  // cover
  const ar = img.width / img.height;
  const boxAr = w / h;
  let drawW, drawH;
  if(ar > boxAr){ drawH = h; drawW = h * ar; } else { drawW = w; drawH = w / ar; }
  const dx = x + (w - drawW)/2;
  const dy = y + (h - drawH)/2;
  ctx.drawImage(img, dx, dy, drawW, drawH);
  ctx.restore();
}
function drawText(ctx, spec, text){
  if(!text || !spec) return;
  ctx.font = spec.font;
  ctx.fillStyle = spec.color;
  ctx.textAlign = spec.align || 'left';
  ctx.textBaseline = 'top'; // â† Y es borde superior de la caja
  let t = text;
  if(spec.maxW){
    while(t.length && ctx.measureText(t).width > spec.maxW){ t = t.slice(0, -1); }
    if(t !== text) t = t.trim() + 'â€¦';
  }
  ctx.fillText(t, spec.x, spec.y);
}
function downloadJPG(canvas, filename, quality=0.92){
  const url = canvas.toDataURL('image/jpeg', Math.min(Math.max(quality,0.5),1));
  const a = document.createElement('a'); a.href = url; a.download = filename || 'documento.jpg';
  document.body.appendChild(a); a.click(); a.remove();
}

/*************************
 * INIT
 *************************/
function fillCountries(){
  $country.innerHTML = '';
  for(const p of PAISES){ const opt = document.createElement('option'); opt.value = p; opt.textContent = p; $country.appendChild(opt); }
}
function fillTemplates(){
  $tplSelect.innerHTML='';
  TEMPLATES.forEach(t=>{ const opt=document.createElement('option'); opt.value=t.id; opt.textContent=t.label; $tplSelect.appendChild(opt); });
  $tplSelect.value = TEMPLATES[0].id;
}
function getTemplateById(id){ return TEMPLATES.find(t=>t.id===id) || TEMPLATES[0]; }
function loadTemplateImage(){
  return new Promise(res=>{
    tplImage = new Image();
    tplImage.crossOrigin='anonymous';
    tplImage.onload = () => {
      // Ajusta el canvas al tamaÃ±o REAL de la imagen de plantilla
      currentTpl.width  = tplImage.naturalWidth;
      currentTpl.height = tplImage.naturalHeight;
      res();
    };
    tplImage.src = currentTpl.src;
  });
}
async function renderPreview(){
  if($canvas.width!==currentTpl.width || $canvas.height!==currentTpl.height){
    $canvas.width=currentTpl.width; $canvas.height=currentTpl.height;
  }
  ctx.clearRect(0,0,$canvas.width,$canvas.height);
  ctx.drawImage(tplImage,0,0,$canvas.width,$canvas.height);
  if(photoImage){ const p=currentTpl.photo; drawRoundedImage(ctx, photoImage, p.x,p.y,p.w,p.h,p.radius||0); }
  const f=currentTpl.fields;
  drawText(ctx, f.surname,  ($surname.value||'').toUpperCase());
  drawText(ctx, f.given,    ($given.value||'').toUpperCase());
  drawText(ctx, f.code,     $code.value||'');
  drawText(ctx, f.category, $category.value||'');
  drawText(ctx, f.country,  $country.value||'');
  drawText(ctx, f.dob,      fmtDate($dob.value));
  drawText(ctx, f.sex,      ($sex.value||'').toUpperCase());
  drawText(ctx, f.since,    fmtDate($since.value));
  drawText(ctx, f.exp,      fmtDate($exp.value));
  drawDebugBoxes(); // â† guÃ­a visual para alinear
  setText($appMsg, 'Vista previa actualizada');
}

/*************************
 * EVENTOS
 *************************/
$tplSelect.addEventListener('change', async ()=>{
  currentTpl=getTemplateById($tplSelect.value);
  await loadTemplateImage();
  renderPreview();
});
$photo.addEventListener('change', (e)=>{
  const file=e.target.files[0];
  if(!file){ photoImage=null; renderPreview(); return; }
  const url=URL.createObjectURL(file);
  const img=new Image();
  img.onload=()=>{ photoImage=img; URL.revokeObjectURL(url); renderPreview(); };
  img.src=url;
});
$btnPrev.addEventListener('click', ()=> renderPreview());
$btnExp.addEventListener('click', ()=>{
  const name=($outName.value||`ID_${($given.value||'')}_${$category.value||''}.jpg`).replace(/\s+/g,'_');
  const q=parseFloat($jpgQ.value||'0.92')||0.92;
  downloadJPG($canvas,name,q);
});
[$surname,$given,$code,$category,$country,$dob,$sex,$since,$exp].forEach(el=>{ el.addEventListener('input', ()=>renderPreview()); });

// Boot
(async function init(){
  fillCountries();
  fillTemplates();
  currentTpl = TEMPLATES[0];
  await loadTemplateImage();
  // Precargar CODE desde ?code=
  const codeParam = getQueryParam('code');
  if(codeParam){ $code.value = codeParam; $code.readOnly = true; }
  renderPreview();
})();
  <script>
// === MODO CALIBRACIÃ“N CON TECLAS ===
// Requiere: DEBUG = true y drawDebugBoxes() ya llamado en renderPreview()

let _tuneIndex = 0;
function _fieldKeys() {
  return Object.keys(currentTpl.fields);
}
function tune(fieldName) {
  const keys = _fieldKeys();
  if (!keys.length) return alert("No hay fields en la plantilla.");
  if (fieldName) {
    const i = keys.indexOf(fieldName);
    if (i >= 0) _tuneIndex = i;
  }
  const k = keys[_tuneIndex];
  const spec = currentTpl.fields[k];
  console.log(`ðŸŽ¯ Tunear: ${k}`, spec);
  // resalta campo actual dibujando de nuevo
  renderPreview();
  // marca visual rÃ¡pida
  const fontPx = parseInt((spec.font.match(/(\d+)px/)||[])[1]||'24',10);
  ctx.save();
  ctx.strokeStyle = '#f59e0b'; // Ã¡mbar para campo activo
  ctx.lineWidth = 2;
  const h = fontPx + 6;
  const w = spec.maxW || 120;
  ctx.strokeRect(spec.x, spec.y, w, h);
  ctx.restore();
  return k;
}
function _nextField() {
  const keys = _fieldKeys();
  if (!keys.length) return;
  _tuneIndex = (_tuneIndex + 1) % keys.length;
  tune();
}
function _logSpec() {
  const k = _fieldKeys()[_tuneIndex];
  console.log(`ðŸ“Ž ${k}:`, JSON.stringify(currentTpl.fields[k], null, 2));
}
function _logAll() {
  console.log("ðŸ“Œ Copia esto dentro de TEMPLATES.fields:");
  console.log(JSON.stringify(currentTpl.fields, null, 2));
}
window.tune = tune;        // usa tune('surname') por ejemplo
window.tuneNext = _nextField;
window.tunePrint = _logSpec;
window.tunePrintAll = _logAll;

// Teclado
window.addEventListener('keydown', (e)=>{
  const keys = _fieldKeys();
  if (!keys.length) return;
  const k = keys[_tuneIndex];
  const s = currentTpl.fields[k];
  const step = e.shiftKey ? 10 : 1;

  let changed = false;

  switch(e.key){
    case 'ArrowLeft':  s.x = Math.max(0, s.x - step); changed = true; break;
    case 'ArrowRight': s.x = s.x + step; changed = true; break;
    case 'ArrowUp':    s.y = Math.max(0, s.y - step); changed = true; break;
    case 'ArrowDown':  s.y = s.y + step; changed = true; break;

    case '[': s.maxW = Math.max(20, (s.maxW||120) - step); changed = true; break;
    case ']': s.maxW = (s.maxW||120) + step; changed = true; break;

    case '+':
    case '=': {
      const m = s.font.match(/(\d+)px/);
      const px = m ? parseInt(m[1],10) : 24;
      s.font = s.font.replace(/(\d+)px/,(px+1)+'px');
      changed = true; break;
    }
    case '-': {
      const m = s.font.match(/(\d+)px/);
      const px = m ? parseInt(m[1],10) : 24;
      s.font = s.font.replace(/(\d+)px/,(Math.max(6,px-1))+'px');
      changed = true; break;
    }

    case 'p':
    case 'P':
      _nextField();
      return;

    case 'Enter':
      _logSpec();
      return;

    // Ctrl+S o Cmd+S â†’ imprime todo (no bloquea guardado del navegador)
    case 's':
    case 'S':
      if (e.ctrlKey || e.metaKey) {
        e.preventDefault();
        _logAll();
        return;
      }
      break;
  }

  if (changed) {
    renderPreview();
    // remarcar actual
    setTimeout(()=> tune(), 0);
  }
});
</script>
</body>
</html>
