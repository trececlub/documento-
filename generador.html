<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Generador de ID â€” JPG</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --text:#e2e8f0; --muted:#94a3b8; --brand:#6366f1; --accent:#22c55e; --danger:#ef4444; --card:#111827;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--text); font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif}
    .wrap{max-width:1100px; margin:0 auto; padding:24px}
    h1{margin:0 0 12px; font-size:22px}
    h2{margin:18px 0 8px; color:var(--muted); font-size:13px; letter-spacing:.04em; text-transform:uppercase}
    .card{background:var(--panel); border:1px solid #1f2937; border-radius:14px; padding:16px; margin-top:12px}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input, select, button{font:14px/1.2 inherit}
    input[type="text"], input[type="date"], input[type="file"], select{width:100%; padding:10px 12px; border-radius:10px; border:1px solid #1f2937; background:#111827; color:#fff}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .grid{display:grid; grid-template-columns:360px 1fr; gap:16px}
    .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:10px; border:1px solid #1f2937; background:#1f2937; color:#fff; cursor:pointer}
    .btn.primary{background:var(--brand); border-color:transparent}
    .btn.success{background:var(--accent); border-color:transparent}
    .hint{font-size:12px; color:var(--muted)}
    .preview{background:#0d1117; border:1px solid #1f2937; border-radius:14px; padding:12px}
    canvas{max-width:100%; height:auto; border-radius:10px; background:#000}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .sep{height:1px; background:#1f2937; margin:14px 0}
    .link{color:#a5b4fc; text-decoration:none}
    code{background:#0b1220; padding:1px 6px; border-radius:6px; border:1px solid #1f2937}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Generador de ID â€” JPG</h1>
    <p class="hint">Rellena el formulario, carga la foto y exporta el documento en JPG. <a class="link" href="./index.html">Volver al inicio</a></p>

    <section class="card">
      <div class="grid">
        <aside>
          <h2>Datos del documento</h2>
          <label>Surname</label>
          <input id="f-surname" type="text" placeholder="Apellido"/>

          <label>Given name</label>
          <input id="f-given" type="text" placeholder="Nombre"/>

          <label>Code</label>
          <input id="f-code" type="text" placeholder="USCIS CODE"/>

          <label>Category</label>
          <select id="f-category">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select>

          <label>Country of birth</label>
          <select id="f-country"></select>

          <div class="row">
            <div>
              <label>Date of birth</label>
              <input id="f-dob" type="date"/>
            </div>
            <div>
              <label>Sex</label>
              <select id="f-sex">
                <option value="M">M</option>
                <option value="F">F</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Card since</label>
              <input id="f-since" type="date"/>
            </div>
            <div>
              <label>Card expires</label>
              <input id="f-exp" type="date"/>
            </div>
          </div>

          <label>Foto (JPG/PNG)</label>
          <input id="f-photo" type="file" accept="image/*"/>
          <p class="hint">Se ajustarÃ¡ al recuadro de la plantilla.</p>

          <div class="sep"></div>
          <div class="toolbar">
            <button id="btn-preview" class="btn">Actualizar vista</button>
            <button id="btn-export" class="btn success">Generar JPG</button>
          </div>

          <h2 style="margin-top:18px">Plantilla</h2>
          <label>Tipo de documento</label>
          <select id="tpl-select"></select>
          <p id="tpl-status" class="hint"></p>

          <!-- === NUEVO: Campos del reverso (opcionales) === -->
          <h2 style="margin-top:18px">Datos del reverso</h2>
          <label>NÃºmero superior (entre A y M)</label>
          <input id="b-topnum" type="text" placeholder="99957553" />
          <label>NÃºmero despuÃ©s de MSC</label>
          <input id="b-mscnum" type="text" placeholder="0000000110" />
          <!-- === /NUEVO === -->

          <div class="sep"></div>
          <label>Nombre de salida</label>
          <input id="out-name" type="text" placeholder="ID_Nombre_Tipo.jpg"/>
          <label>Calidad JPG (0.8â€“1)</label>
          <input id="jpg-quality" type="text" value="0.92"/>
        </aside>

        <div class="preview">
          <h2>Vista previa</h2>
          <canvas id="canvas" width="1011" height="638"></canvas>
          <p id="app-msg" class="hint"></p>
        </div>
      </div>
    </section>
  </div>

<script>
// GUARD: bloquea acceso directo si no hay sesiÃ³n vÃ¡lida
if (sessionStorage.getItem('docgen_auth') !== '1') {
  window.location.replace('index.html');
}

/************** UTIL: query **************/
function getQueryParam(name){
  return new URLSearchParams(window.location.search).get(name);
}

/************** CONFIG **************/
const PAISES = [ "AfganistÃ¡n","Albania","Alemania","Andorra","Angola","Antigua y Barbuda","Arabia Saudita","Argelia","Argentina","Armenia","Australia","Austria","AzerbaiyÃ¡n","Bahamas","BangladÃ©s","Barbados","BarÃ©in","BÃ©lgica","Belice","BenÃ­n","Bielorrusia","Bolivia","Bosnia y Herzegovina","Botsuana","Brasil","BrunÃ©i","Bulgaria","Burkina Faso","Burundi","ButÃ¡n","Cabo Verde","Camboya","CamerÃºn","CanadÃ¡","Catar","Chad","Chile","China","Chipre","Colombia","Comoras","Corea del Norte","Corea del Sur","Costa de Marfil","Costa Rica","Croacia","Cuba","Dinamarca","Dominica","Ecuador","Egipto","El Salvador","Emiratos Ãrabes Unidos","Eritrea","Eslovaquia","Eslovenia","EspaÃ±a","Estados Unidos","Estonia","Esuatini","EtiopÃ­a","Filipinas","Finlandia","Fiyi","Francia","GabÃ³n","Gambia","Georgia","Ghana","Granada","Grecia","Guatemala","Guinea","Guinea-BisÃ¡u","Guinea Ecuatorial","Guyana","HaitÃ­","Honduras","HungrÃ­a","India","Indonesia","Irak","IrÃ¡n","Irlanda","Islandia","Islas Marshall","Islas SalomÃ³n","Israel","Italia","Jamaica","JapÃ³n","Jordania","KazajistÃ¡n","Kenia","KirguistÃ¡n","Kiribati","Kuwait","Laos","Lesoto","Letonia","LÃ­bano","Liberia","Libia","Liechtenstein","Lituania","Luxemburgo","Madagascar","Malasia","Malaui","Maldivas","MalÃ­","Malta","Marruecos","Mauricio","Mauritania","MÃ©xico","Micronesia","Moldavia","MÃ³naco","Mongolia","Montenegro","Mozambique","Namibia","Nauru","Nepal","Nicaragua","NÃ­ger","Nigeria","Noruega","Nueva Zelanda","OmÃ¡n","PaÃ­ses Bajos","PakistÃ¡n","Palaos","PanamÃ¡","PapÃºa Nueva Guinea","Paraguay","PerÃº","Polonia","Portugal","Reino Unido","RepÃºblica Centroafricana","RepÃºblica Checa","RepÃºblica del Congo","RepÃºblica DemocrÃ¡tica del Congo","RepÃºblica Dominicana","Ruanda","RumanÃ­a","Rusia","Samoa","San CristÃ³bal y Nieves","San Marino","San Vicente y las Granadinas","Santa LucÃ­a","Santo TomÃ© y PrÃ­ncipe","Senegal","Serbia","Seychelles","Sierra Leona","Singapur","Siria","Somalia","Sri Lanka","SudÃ¡frica","SudÃ¡n","SudÃ¡n del Sur","Suecia","Suiza","Surinam","Tailandia","Tanzania","TayikistÃ¡n","Timor Oriental","Togo","Tonga","Trinidad y Tobago","TÃºnez","TurkmenistÃ¡n","TurquÃ­a","Tuvalu","Ucrania","Uganda","Uruguay","UzbekistÃ¡n","Vanuatu","Vaticano","Venezuela","Vietnam","Yemen","Yibuti","Zambia","Zimbabue" ];

/* âš ï¸ Ajusta nombres/formatos reales de tus imÃ¡genes en /templates/ */
const TEMPLATES = [
  {
    id:"card", label:"Card (frente)",
    width:1011, height:638,
    src:"./templates/card.png",
    fields:{
      surname:{x:742,y:271,maxW:620,font:"bold 54px Inter, system-ui",color:"#111",align:"left"},
      given:{x:741,y:428,maxW:620,font:"600 52px Inter, system-ui",color:"#222",align:"left"},
      code:{x:740,y:576,maxW:620,font:"500 50px Inter, system-ui",color:"#333",align:"left"},
      category:{x:1180,y:574,maxW:620,font:"500 54px Inter, system-ui",color:"#333",align:"left"},
      country:{x:740,y:723,maxW:620,font:"500 55px Inter, system-ui",color:"#333",align:"left"},
      dob:{x:740,y:880,maxW:300,font:"500 51px Inter, system-ui",color:"#333",align:"left"},
      sex:{x:1193,y:868,maxW:120,font:"700 57px Inter, system-ui",color:"#111",align:"left"},
      exp:{x:1189,y:956,maxW:300,font:"700 52px Inter, system-ui",color:"#111",align:"left"},
      since:{x:1190,y:1026,maxW:300,font:"500 54px Inter, system-ui",color:"#333",align:"left"}
    },
    photo:{x:86,y:398,w:508,h:607,radius:20}
  },
  {
    id:"social", label:"Social (frente)",
    width:1011, height:638,
    src:"./templates/social.png",
    fields:{
      surname:{x:742,y:271,maxW:620,font:"bold 54px Inter, system-ui",color:"#111",align:"left"},
      given:{x:741,y:428,maxW:620,font:"600 52px Inter, system-ui",color:"#222",align:"left"},
      code:{x:740,y:576,maxW:620,font:"500 50px Inter, system-ui",color:"#333",align:"left"},
      category:{x:1180,y:574,maxW:620,font:"500 54px Inter, system-ui",color:"#333",align:"left"},
      country:{x:740,y:723,maxW:620,font:"500 55px Inter, system-ui",color:"#333",align:"left"},
      dob:{x:740,y:880,maxW:300,font:"500 51px Inter, system-ui",color:"#333",align:"left"},
      sex:{x:1193,y:868,maxW:120,font:"700 57px Inter, system-ui",color:"#111",align:"left"},
      exp:{x:1189,y:956,maxW:300,font:"700 52px Inter, system-ui",color:"#111",align:"left"},
      since:{x:1190,y:1026,maxW:300,font:"500 54px Inter, system-ui",color:"#333",align:"left"}
    },
    photo:{x:86,y:398,w:508,h:607,radius:20}
  },

  /* === NUEVO: plantilla reverso === */
  {
    id:"card_back", label:"Card (posterior)",
    width:1218, height:768,                 /* ajusta al tamaÃ±o real de tu PNG */
    src:"./templates/card_back.png",
    isBack:true,
    photo:{ x: 50, y: 100, w: 360, h: 260, radius: 16 }, /* calibra con debug */
    fields:{
      topnum:{ x: 210, y: 32,  maxW: 260, font:"700 36px Inter, system-ui", color:"#111", align:"left" },   // nÃºmero superior
      mscnum:{ x: 980, y: 560, maxW: 220, font:"700 36px Inter, system-ui", color:"#111", align:"left" },   // nÃºmero tras "MSC"
      mrz1:{   x: 40,  y: 600, maxW: 1120, font:"800 54px Inter, system-ui", color:"#111", align:"left" },  // lÃ­nea 1
      mrz2:{   x: 40,  y: 650, maxW: 1120, font:"800 54px Inter, system-ui", color:"#111", align:"left" },  // lÃ­nea 2
      mrz3:{   x: 40,  y: 700, maxW: 1120, font:"800 54px Inter, system-ui", color:"#111", align:"left" }   // lÃ­nea 3 (apellidos/nombre)
    }
  }
  /* === /NUEVO === */
];

/************** ESTADO + DOM **************/
let currentTpl = TEMPLATES[0];
let tplImage = new Image();
let photoImage = null;

const $tplSelect = document.getElementById('tpl-select');
const $canvas = document.getElementById('canvas');
const ctx = $canvas.getContext('2d');

const $surname = document.getElementById('f-surname');
const $given   = document.getElementById('f-given');
const $code    = document.getElementById('f-code');
const $category= document.getElementById('f-category');
const $country = document.getElementById('f-country');
const $dob     = document.getElementById('f-dob');
const $sex     = document.getElementById('f-sex');
const $since   = document.getElementById('f-since');
const $exp     = document.getElementById('f-exp');
const $photo   = document.getElementById('f-photo');
const $btnPrev = document.getElementById('btn-preview');
const $btnExp  = document.getElementById('btn-export');
const $outName = document.getElementById('out-name');
const $jpgQ    = document.getElementById('jpg-quality');
const $appMsg  = document.getElementById('app-msg');
const $tplStatus = document.getElementById('tpl-status');

/* NUEVO: refs reverso */
const $bTop = document.getElementById('b-topnum');
const $bMSC = document.getElementById('b-mscnum');

/************** DEBUG **************/
const DEBUG = true; // pon en true para calibrar

function drawDebugBoxes(){
  if(!DEBUG) return;
  ctx.save();
  if(currentTpl.photo){
    const p = currentTpl.photo;
    ctx.strokeStyle = '#8b5cf6'; ctx.lineWidth = 2;
    ctx.strokeRect(p.x, p.y, p.w, p.h);
  }
  const f = currentTpl.fields || {};
  ctx.strokeStyle = '#10b981'; ctx.lineWidth = 2;
  for(const k of Object.keys(f)){
    const s = f[k];
    const fontPx = parseInt((s.font?.match(/(\d+)px/)||[])[1]||'24',10);
    const h = fontPx + 6;
    const w = s.maxW || Math.max(80, ctx.measureText('MMMMMMMM').width);
    ctx.strokeRect(s.x, s.y, w, h);
  }
  ctx.restore();
}

/************** UTILS DRAW **************/
function setText(el, txt){ el.textContent = txt; }
function fmtDate(iso){
  if(!iso) return "";
  const d = new Date(iso);
  if(Number.isNaN(d.getTime())) return iso;
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yy = d.getFullYear();
  return `${dd}/${mm}/${yy}`;
}
function drawRoundedImage(ctx, img, x, y, w, h, r){
  ctx.save();
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.lineTo(x+w-rr, y);
  ctx.quadraticCurveTo(x+w, y, x+w, y+rr);
  ctx.lineTo(x+w, y+h-rr);
  ctx.quadraticCurveTo(x+w, y+h, x+w-rr, y+h);
  ctx.lineTo(x+rr, y+h);
  ctx.quadraticCurveTo(x, y+h, x, y+h-rr);
  ctx.lineTo(x, y+rr);
  ctx.quadraticCurveTo(x, y, x+rr, y);
  ctx.closePath();
  ctx.clip();
  // cover
  const ar = img.width / img.height;
  const boxAr = w / h;
  let drawW, drawH;
  if(ar > boxAr){ drawH = h; drawW = h * ar; } else { drawW = w; drawH = w / ar; }
  const dx = x + (w - drawW)/2;
  const dy = y + (h - drawH)/2;
  ctx.drawImage(img, dx, dy, drawW, drawH);
  ctx.restore();
}

/* === Blanco y Negro (fallback robusto) === */
function drawRoundedImageBW(ctx, img, x, y, w, h, r=0){
  const ar = img.width / img.height;
  const boxAr = w / h;
  let drawW, drawH;
  if (ar > boxAr) { drawH = h; drawW = h * ar; }
  else            { drawW = w; drawH = w / ar; }
  const off = document.createElement('canvas');
  off.width  = Math.ceil(drawW);
  off.height = Math.ceil(drawH);
  const octx = off.getContext('2d');
  octx.drawImage(img, 0, 0, off.width, off.height);
  const imgData = octx.getImageData(0, 0, off.width, off.height);
  const data = imgData.data;
  for (let i = 0; i < data.length; i += 4) {
    const yv = 0.2126*data[i] + 0.7152*data[i+1] + 0.0722*data[i+2];
    data[i] = data[i+1] = data[i+2] = yv;
  }
  octx.putImageData(imgData, 0, 0);
  ctx.save();
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.lineTo(x+w-rr, y);
  ctx.quadraticCurveTo(x+w, y, x+w, y+rr);
  ctx.lineTo(x+w, y+h-rr);
  ctx.quadraticCurveTo(x+w, y+h, x+w-rr, y+h);
  ctx.lineTo(x+rr, y+h);
  ctx.quadraticCurveTo(x, y+h, x, y+h-rr);
  ctx.lineTo(x, y+rr);
  ctx.quadraticCurveTo(x, y, x+rr, y);
  ctx.closePath();
  ctx.clip();
  const dx = x + (w - off.width) / 2;
  const dy = y + (h - off.height) / 2;
  ctx.drawImage(off, dx, dy);
  ctx.restore();
}

function drawText(ctx, spec, text){
  if(!text || !spec) return;
  ctx.font = spec.font;
  ctx.fillStyle = spec.color;
  ctx.textAlign = spec.align || 'left';
  ctx.textBaseline = 'top';
  let t = text;
  if(spec.maxW){
    while(t.length && ctx.measureText(t).width > spec.maxW){ t = t.slice(0, -1); }
    if(t !== text) t = t.trim() + 'â€¦';
  }
  ctx.fillText(t, spec.x, spec.y);
}
function downloadJPG(canvas, filename, quality=0.92){
  const url = canvas.toDataURL('image/jpeg', Math.min(Math.max(quality,0.5),1));
  const a = document.createElement('a'); a.href = url; a.download = filename || 'documento.jpg';
  document.body.appendChild(a); a.click(); a.remove();
}

/************** MRZ utils (REEMPLAZA ESTA SECCIÃ“N) **************/
const MRZ_LINE_LEN = 30;

// LÃ­nea 1 base (30 chars) â€” solo cambia el nÃºmero tras "MSC" (10 dÃ­gitos)
const MRZ_L1_BASE   = "C1USA1234567897MSC0000000110<<";

// LÃ­nea 2 base (30 chars) = prefijo (15) + ISO3 paÃ­s (3) + sufijo (12)
const MRZ_L2_PREFIX = "0210203F3210260";
const MRZ_L2_SUFFIX = "<<<<<<<<<<<4";

// Sanitiza a MRZ: mayÃºsculas, sin acentos, solo Aâ€“Z 0â€“9 y '<' como espacio
function mrzSanitize(s){
  if(!s) return '';
  return s.normalize('NFD')
          .replace(/[\u0300-\u036f]/g,'') // sin acentos
          .toUpperCase()
          .replace(/[^A-Z0-9 ]/g,' ')     // solo A-Z, 0-9 y espacios
          .trim()
          .replace(/\s+/g,'<');           // espacios â†’ '<'
}

// Convierte paÃ­s a â€œcÃ³digo de 3 letrasâ€ (a falta de tabla ISO real)
function countryToISO3(name){
  if(!name) return 'XXX';
  const t = mrzSanitize(name).replace(/<+/g,'');
  return (t.slice(0,3) || 'XXX').padEnd(3,'X');
}

// Utilidad: recorta/pad a 30 con '<'
function fit30(s){
  let out = (s || '').slice(0, MRZ_LINE_LEN);
  if(out.length < MRZ_LINE_LEN) out = out + '<'.repeat(MRZ_LINE_LEN - out.length);
  return out;
}

// >>> ESTA FUNCIÃ“N ES LA QUE USA EL RENDER DEL REVERSO <<<
function buildBackLines(){
  // 1) LÃNEA 1 (fija con hueco MSC[10dÃ­gitos])
  const mscIn = ($bMSC?.value || '').replace(/\D+/g,'').slice(0,10).padStart(10,'0');
  // sustituye el bloque MSCxxxxxxxxxx conservando el resto tal cual
  let L1 = MRZ_L1_BASE.replace(/MSC\d{10}/, "MSC" + mscIn);
  L1 = fit30(L1); // por seguridad, mantiene 30

  // 2) LÃNEA 2 (prefijo + ISO3 paÃ­s + sufijo)
  const iso3 = countryToISO3($country.value).slice(0,3);
  let L2 = MRZ_L2_PREFIX + iso3 + MRZ_L2_SUFFIX; // = 15 + 3 + 12 = 30
  L2 = fit30(L2);

  // 3) LÃNEA 3 (AP1 << AP2 < NOMBRE + relleno '<' hasta 30)
  const ap1   = mrzSanitize($surname.value).replace(/<+/g,''); // 1er apellido
  const ap2In = ""; // no tenemos 2Âº apellido en el formulario; si existiera, colÃ³calo aquÃ­
  const ap2   = ap2In ? mrzSanitize(ap2In).replace(/<+/g,'') : '<<<<<<<<'; // relleno si falta
  const given = mrzSanitize($given.value).replace(/<+/g,'');
  const givenInitial = given.slice(0,1) || 'V'; // en tu ejemplo es una inicial

  // Ensamblado exacto como tu ejemplo: "AP1<<AP2<N<<<<<<<<<<<<<<"
  let L3core = `${ap1}<<${ap2}<${givenInitial}`;
  let L3 = fit30(L3core); // rellena con '<' hasta 30, o recorta si excede

  return { L1, L2, L3 };
}

/************** SELECT + LOADERS **************/
function fillCountries(){
  $country.innerHTML = '';
  for(const p of PAISES){
    const opt = document.createElement('option');
    opt.value = p; opt.textContent = p;
    $country.appendChild(opt);
  }
}
function fillTemplates(){
  $tplSelect.innerHTML = '';
  if (!Array.isArray(TEMPLATES) || TEMPLATES.length === 0){
    const opt = document.createElement('option');
    opt.value = ''; opt.textContent = 'â€” Sin plantillas â€”';
    opt.disabled = true; opt.selected = true;
    $tplSelect.appendChild(opt);
    $tplSelect.disabled = true;
    return;
  }
  TEMPLATES.forEach(t=>{
    const opt = document.createElement('option');
    opt.value = t.id; opt.textContent = t.label || t.id;
    $tplSelect.appendChild(opt);
  });
  $tplSelect.disabled = false;
  $tplSelect.value = TEMPLATES[0].id;
}
function getTemplateById(id){ return TEMPLATES.find(t=>t.id===id) || TEMPLATES[0]; }

function tryLoadImage(url){
  return new Promise((resolve, reject)=>{
    const img = new Image();
    img.onload = ()=> resolve(img);
    img.onerror = ()=> reject(new Error("No se pudo cargar: " + url));
    img.src = url + (url.includes("?") ? "&" : "?") + "v=" + Date.now();
  });
}
async function loadTemplateImage(){
  const src = currentTpl.src;
  const fname = src.split("/").pop();
  const candidates = [
    src,
    `/documento-/templates/${fname}`,
    `./templates/${fname}`
  ];
  let lastErr = null;
  for (const url of candidates){
    try{
      const img = await tryLoadImage(url);
      tplImage = img;
      currentTpl.width  = img.naturalWidth;
      currentTpl.height = img.naturalHeight;
      if($tplStatus) $tplStatus.textContent = `âœ… Plantilla cargada: ${fname} â€” ${img.naturalWidth}Ã—${img.naturalHeight}px`;
      return;
    }catch(e){
      lastErr = e;
      console.warn(e.message);
    }
  }
  if($tplStatus) $tplStatus.textContent = `âŒ No se pudo cargar "${fname}". Revisa /templates/. Ãšltimo error: ${lastErr?.message||''}`;
  throw lastErr || new Error("Fallo al cargar plantilla");
}

/************** RENDER **************/
async function renderPreview(){
  if($canvas.width!==currentTpl.width || $canvas.height!==currentTpl.height){
    $canvas.width=currentTpl.width; $canvas.height=currentTpl.height;
  }
  ctx.clearRect(0,0,$canvas.width,$canvas.height);
  if(tplImage?.naturalWidth) ctx.drawImage(tplImage,0,0,$canvas.width,$canvas.height);

  // FOTO B/N (si hay caja foto)
  if (photoImage && currentTpl.photo) {
    const p = currentTpl.photo;
    if (typeof ctx.filter === 'string') {
      ctx.save(); ctx.filter = 'grayscale(100%)';
      drawRoundedImage(ctx, photoImage, p.x, p.y, p.w, p.h, p.radius || 0);
      ctx.filter = 'none'; ctx.restore();
    } else {
      drawRoundedImageBW(ctx, photoImage, p.x, p.y, p.w, p.h, p.radius || 0);
    }
  }

  const f = currentTpl.fields || {};

  /* === RENDER REVERSO === */
  if (currentTpl.isBack === true) {
    const { top, msc, L1, L2, L3 } = buildBackLines();
    drawText(ctx, f.topnum, top);
    drawText(ctx, f.mscnum, msc);
    drawText(ctx, f.mrz1,   L1);
    drawText(ctx, f.mrz2,   L2);
    drawText(ctx, f.mrz3,   L3);
    drawDebugBoxes();
    setText($appMsg, 'Vista previa (reverso) actualizada');
    return; // no seguir con el frontal
  }

  /* === RENDER FRENTE === */
  drawText(ctx, f.surname,  ($surname.value||'').toUpperCase());
  drawText(ctx, f.given,    ($given.value||'').toUpperCase());
  drawText(ctx, f.code,     $code.value||'');
  drawText(ctx, f.category, $category.value||'');
  drawText(ctx, f.country,  $country.value||'');
  drawText(ctx, f.dob,      fmtDate($dob.value));
  drawText(ctx, f.sex,      ($sex.value||'').toUpperCase());
  drawText(ctx, f.exp,      fmtDate($exp.value));
  drawText(ctx, f.since,    fmtDate($since.value));
  drawDebugBoxes();
  setText($appMsg, 'Vista previa actualizada');
}

/************** EVENTOS UI **************/
$tplSelect.addEventListener('change', async ()=>{
  try{
    currentTpl=getTemplateById($tplSelect.value);
    await loadTemplateImage();
    renderPreview();
  }catch(e){
    console.warn('No se pudo cargar esta plantilla:', e);
    ctx.clearRect(0,0,$canvas.width,$canvas.height);
    setText($appMsg, 'No se pudo cargar la plantilla seleccionada. Revisa /templates/.');
  }
});
$photo.addEventListener('change', (e)=>{
  const file=e.target.files[0];
  if(!file){ photoImage=null; renderPreview(); return; }
  const url=URL.createObjectURL(file);
  const img=new Image();
  img.onload=()=>{ photoImage=img; URL.revokeObjectURL(url); renderPreview(); };
  img.src=url;
});
$btnPrev.addEventListener('click', ()=> renderPreview());
$btnExp.addEventListener('click', ()=>{
  const name=($outName.value||`ID_${($given.value||'')}_${$category.value||''}.jpg`).replace(/\s+/g,'_');
  const q=parseFloat($jpgQ.value||'0.92')||0.92;
  downloadJPG($canvas,name,q);
});
[$surname,$given,$code,$category,$country,$dob,$sex,$since,$exp].forEach(el=> el.addEventListener('input', ()=>renderPreview()) );
[$bTop,$bMSC].forEach(el=> el && el.addEventListener('input', ()=>renderPreview()) );

/************** INIT **************/
(async function init(){
  fillCountries();
  fillTemplates();
  currentTpl = getTemplateById($tplSelect.value || TEMPLATES[0]?.id);
  try{
    await loadTemplateImage();
  }catch(e){
    // sigue con lienzo en blanco para permitir cambiar plantilla
  }
  const codeParam = getQueryParam('code');
  if(codeParam){ document.getElementById('f-code').value = codeParam; document.getElementById('f-code').readOnly = true; }
  renderPreview();
})();

/************** MODO CALIBRACIÃ“N CON TECLAS **************/
let _tuneIndex = 0;
function _fieldKeys(){ return Object.keys(currentTpl.fields||{}); }
function tune(fieldName){
  const keys = _fieldKeys();
  if (!keys.length) return alert("No hay fields en la plantilla.");
  if (fieldName) {
    const i = keys.indexOf(fieldName);
    if (i >= 0) _tuneIndex = i;
  }
  const k = keys[_tuneIndex];
  const spec = currentTpl.fields[k];
  console.log(`ðŸŽ¯ Tunear: ${k}`, spec);
  renderPreview();
  const fontPx = parseInt((spec.font?.match(/(\d+)px/)||[])[1]||'24',10);
  ctx.save();
  ctx.strokeStyle = '#f59e0b'; ctx.lineWidth = 2;
  const h = fontPx + 6;
  const w = spec.maxW || 120;
  ctx.strokeRect(spec.x, spec.y, w, h);
  ctx.restore();
  return k;
}
function tuneNext(){ const keys=_fieldKeys(); if(!keys.length) return; _tuneIndex = (_tuneIndex+1)%keys.length; tune(); }
function tunePrint(){ const k=_fieldKeys()[_tuneIndex]; console.log(`ðŸ“Ž ${k}:`, JSON.stringify(currentTpl.fields[k], null, 2)); }
function tunePrintAll(){ console.log("ðŸ“Œ Copia esto dentro de TEMPLATES.fields:"); console.log(JSON.stringify(currentTpl.fields, null, 2)); }
window.tune = tune; window.tuneNext = tuneNext; window.tunePrint = tunePrint; window.tunePrintAll = tunePrintAll;

window.addEventListener('keydown', (e)=>{
  const keys = _fieldKeys(); if (!keys.length) return;
  const k = keys[_tuneIndex]; const s = currentTpl.fields[k];
  const step = e.shiftKey ? 10 : 1;
  let changed = false;

  switch(e.key){
    case 'ArrowLeft':  s.x = Math.max(0, s.x - step); changed = true; break;
    case 'ArrowRight': s.x = s.x + step; changed = true; break;
    case 'ArrowUp':    s.y = Math.max(0, s.y - step); changed = true; break;
    case 'ArrowDown':  s.y = s.y + step; changed = true; break;
    case '[': s.maxW = Math.max(20, (s.maxW||120) - step); changed = true; break;
    case ']': s.maxW = (s.maxW||120) + step; changed = true; break;
    case '+':
    case '=': {
      const m = s.font.match(/(\d+)px/); const px = m ? parseInt(m[1],10) : 24;
      s.font = s.font.replace(/(\d+)px/,(px+1)+'px'); changed = true; break;
    }
    case '-': {
      const m = s.font.match(/(\d+)px/); const px = m ? parseInt(m[1],10) : 24;
      s.font = s.font.replace(/(\d+)px/,(Math.max(6,px-1))+'px'); changed = true; break;
    }
    case 'p': case 'P': tuneNext(); return;
    case 'Enter':      tunePrint(); return;
    case 's': case 'S':
      if (e.ctrlKey || e.metaKey) { e.preventDefault(); tunePrintAll(); return; }
      break;
  }
  if (changed) { renderPreview(); setTimeout(()=> tune(), 0); }
});
</script>
</body>
</html>
